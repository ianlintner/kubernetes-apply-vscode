name: Publish Extension

on:
  workflow_dispatch:
    inputs:
      publish:
        description: 'If true, publish to the VS Code Marketplace (danger: irreversible)'
        type: boolean
        required: false
        default: false
  release:
    types:
      - published
  push:
    tags:
      - 'v*.*.*'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # For releases, build exactly what was released (the tag), not whatever is currently on main.
          ref: ${{ github.event_name == 'release' && github.event.release.tag_name || github.ref }}
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Ensure release/tag commit is on main
        if: github.event_name == 'release'
        run: |
          set -euo pipefail
          git fetch origin main --no-tags

          # We checked out the release tag above, so HEAD is the tag commit.
          if git merge-base --is-ancestor HEAD origin/main; then
            echo "Release tag commit is contained in main; continuing."
          else
            echo "Release tag commit is NOT contained in main; skipping publish." >&2
            echo "SKIP_PUBLISH=1" >> "$GITHUB_ENV"
          fi

      - name: Verify tag matches package.json version
        if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'release'
        run: |
          node -e "const v=require('./package.json').version; const tag=(process.env.GITHUB_EVENT_NAME==='release' ? (require(process.env.GITHUB_EVENT_PATH).release.tag_name) : process.env.GITHUB_REF_NAME); const t=String(tag||'').replace(/^v/,''); if(!t){ console.error('Could not determine tag name for version check'); process.exit(1);} if(v!==t){ console.error(`Version mismatch: package.json=${v} tag=${t}`); process.exit(1);} console.log(`Version OK: ${v}`);"

      - name: Skip publish if version already exists in Marketplace
        if: (startsWith(github.ref, 'refs/tags/v') || github.event_name == 'release' || github.event.inputs.publish == 'true') && env.SKIP_PUBLISH != '1'
        run: |
          set -euo pipefail

          node - <<'NODE'
          const fs = require('fs');
          const cp = require('child_process');
          const pkg = require('./package.json');

          const extensionId = `${pkg.publisher}.${pkg.name}`;
          const targetVersion = String(pkg.version);

          // Marketplace info is public; this does not require auth.
          let raw;
          try {
            raw = cp.execSync(`npx --yes @vscode/vsce show ${extensionId} --json`, {
              stdio: ['ignore', 'pipe', 'pipe'],
              encoding: 'utf8',
            });
          } catch (e) {
            // If the extension doesn't exist yet (first publish), vsce may error.
            // In that case, we should proceed with publishing.
            const stderr = e?.stderr ? String(e.stderr) : '';
            console.log(`vsce show failed (likely first publish). Proceeding. ${stderr}`);
            process.exit(0);
          }

          let data;
          try {
            data = JSON.parse(raw);
          } catch {
            console.log('Could not parse vsce show output; proceeding with publish.');
            process.exit(0);
          }

          const versions = Array.isArray(data?.versions)
            ? data.versions.map((v) => (typeof v === 'string' ? v : v?.version)).filter(Boolean)
            : [];

          if (versions.includes(targetVersion)) {
            console.log(`Version ${targetVersion} already published for ${extensionId}; skipping publish.`);
            fs.appendFileSync(process.env.GITHUB_ENV, 'SKIP_PUBLISH=1\n');
          } else {
            console.log(`Version ${targetVersion} not found in Marketplace for ${extensionId}; continuing.`);
          }
          NODE

      - name: Compile
        run: npm run compile

      - name: Package VSIX
        run: npm run package

      - name: Publish to Visual Studio Marketplace
        if: (startsWith(github.ref, 'refs/tags/v') || github.event_name == 'release' || github.event.inputs.publish == 'true') && env.SKIP_PUBLISH != '1'
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: npx --yes @vscode/vsce publish -p "$VSCE_PAT"
